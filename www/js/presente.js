document.addEventListener("deviceready",onDeviceReady,!1);var currentCursoID=0,currentUserID=0,CHANEL="7A9C3B55-78D0-44A7-A94E-A93E3FE118CE",DEBUG=!1;function onDeviceReady(){$("#preloader-presente").hide();currentCursoID=localStorage.getItem("currentCursoID");currentUserID=localStorage.getItem("user_id");Server.initialize(function(){ko.applyBindings(new PresenteViewModel)},function(){console.log("error :(")})}function internet(){return navigator.connection.type!=Connection.NONE}
function TeacherViewModel(a){this.device_mac="";a&&(this.name=a.name,this.device_mac=a.device_mac)}
function PresenteViewModel(){var a=this;a.id=currentUserID;a.teacherDevice=null;a.connectedTeacher=null;a.PrepareInterval=null;a.connection_interval=null;a.read_interval=null;a.estoyPresente=!1;a.chequearPresenteInterval=null;a.currentClaseID=0;a.teacher=ko.observable(new TeacherViewModel({name:"cargando profesor...",device_mac:"..."}));a.getClaseSuccess=function(b){b.status?(a.currentClaseID=b.id,a.chequearPresenteInterval=window.setInterval(a.chequearPresente,1E3)):($("#preloader-presente").hide(),
swal("\u00a1Un momento!","El profesor a\u00fan no est\u00e1 tomando asistencia. \n Intent\u00e1 nuevamente en unos segundos","error"))};a.getDataSuccess=function(b){a.teacher(new TeacherViewModel({name:b.nombre_profesor+" "+b.apellido_profesor,device_mac:b.address_profesor}))};a.getDataFailure=function(a){alert.error(a.error)};a.OpenBluetoothSuccess=function(){};a.getPresenteSuccess=function(b){b.status?($("#preloader-presente").hide(),swal("Tu asistencia fue registrada!","","success"),a.estoyPresente=
!0,window.clearInterval(a.chequearPresenteInterval)):1==b.id&&($("#preloader-presente").hide(),swal("El profesor te marc\u00f3 como ausente","","error"),window.clearInterval(a.chequearPresenteInterval))};a.getPresenteFailure=function(a){$("#preloader-presente").hide();alert("mugre")};a.chequearPresente=function(){Server.estaPresente(a.id,a.currentClaseID,a.getPresenteSuccess,a.getPresenteFailure)};a.givePresent=function(){window.BTPlugin.enableVisibility(function(){console.log("visible ok")},function(){alert("jajaj")});
$("#preloader-presente").show();BC.Bluetooth.OpenBluetooth(a.OpenBluetoothSuccess,function(){alert("bluetooth open error!")});BC.bluetooth.addEventListener("newdevice",a.deviceFound);0!=a.currentClaseID?a.chequearPresenteInterval=window.setInterval(a.chequearPresente,1E3):Server.obtenerUltimaClase(currentCursoID,a.getClaseSuccess,a.getClaseFailure)};a.deviceFound=function(b){b=b.target;b.deviceAddress==a.teacher().device_mac?(a.teacherDevice=b,a.teacherDevice.connect(a.connectionSuccess,a.connectionError,
CHANEL,!0),a.teacherDevice.addEventListener("deviceconnected",a.prepareTeacherAndRead)):DEBUG&&Materialize.toast("Encontre a: "+b.deviceName+"",2E3,"rounded")};a.onDataAvaliable=function(a){alert(a)};a.connectionSuccess=function(){};a.connectionError=function(){DEBUG&&Materialize.toast("no se pudo establecer conexion"+a.name+"reintentando",2E3,"rounded");a.teacherDevice.connect(a.connectionSuccess,a.connectionError,CHANEL,!0)};a.prepareTeacherAndRead=function(b){a.teacherDevice=b;Materialize.toast("Me conecte con el profesor",
3E3,"rounded");a.teacherDevice.prepare(a.tryRead,a.prepareError)};a.tryRead=function(){a.teacherDevice.rfcommRead(a.readSuccess,a.readError)};a.tryPrepare=function(){a.teacherDevice.prepare(a.setTryReadInterval,a.prepareError)};a.prepareError=function(b){DEBUG&&Materialize.toast("error preparing teacher device intentando de nuevo",2E3,"rounded");a.teacherDevice.prepare(a.tryRead,a.prepareError);console.log(b)};a.readError=function(){a.teacherDevice.rfcommRead(a.readSuccess,a.readError);DEBUG&&Materialize.toast("error leyendo del canal rfcomm, intentando de nuevo.",
2E3,"rounded")};a.readSuccess=function(b){var c=b.value.getASCIIString();b=new String("ping");c=c.slice(0,4);b.valueOf()==c.valueOf()?(swal("Estas Presente!","","success"),$("#preloader-presente").hide()):(DEBUG&&Materialize.toast("Lo que lei no es mi dato jiji",2E3,"rounded"),a.teacherDevice.rfcommRead(a.readSuccess,a.readError))};a.writeSuccess=function(){Materialize.toast("Se envio la confirmaci\u00f3n correctamente.",2E3,"rounded");$("#preloader-presente").hide();a.teacherDevice.disconnect(a.disconnectSuccess,
a.disconnectError)};a.writeError=function(){DEBUG&&Materialize.toast("No se pudo escribir, intentando de nuevo",2E3,"rounded");a.teacherDevice.rfcommWrite("ascii","ok",function(){alert("escribi")},a.writeError())};a.disconnectSuccess=function(){Materialize.toast("Se desconecto del profesor correctamente.",2E3,"rounded")};a.disconnectError=function(){DEBUG&&Materialize.toast("no se pudo desconectar, intentando de nuevo.",1E3,"rounded");a.teacherDevice.disconnect(a.disconnectSuccess,a.disconnectError)};
a.initialize=function(){if(internet())Server.getCurso(currentCursoID,a.getDataSuccess,a.getDataFailure);else{var b=window.localStorage.getItem("currentCurso"),b=JSON.parse(b);a.getDataSuccess(b)}};a.initialize()};