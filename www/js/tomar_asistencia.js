var DEBUG=!1,CHANEL="7A9C3B55-78D0-44A7-A94E-A93E3FE118CE",username="movilesbluetooth",password="3mFh5qNR",getCursoURL="http://movilesbluetooth.php.info.unlp.edu.ar/cursos/",currentCursoID=0,currentClassID,currentCursoName,currentStudentID;document.addEventListener("deviceready",onDeviceReady,!1);
function onDeviceReady(){$(".collapsible").collapsible({accordion:!1});currentCursoID=window.localStorage.getItem("currentCursoID");currentCursoName=window.localStorage.getItem("currentCurso_Name");$("#completar").hide();cordovaHTTP.useBasicAuth(username,password,function(){console.log("success!");window.vm=new AsistenciaViewModel;ko.applyBindings(vm)},function(){console.log("error :(")})}function logmsg(b){DEBUG?Materialize.toast(b,2E3,"rounded"):console.log(b)}
function AlumnoViewModel(b){var a=this;a.device=null;a.connectedDevice=null;a.device_mac="";a.present=ko.observable(!1);a.inscripted=ko.observable(!1);a.name="";a.MAXATTEMPS=20;a.triesCounter=0;a.id=0;a.ConnectingToDevice=!1;a.PreparingDevice=!1;a.ReadingDevice=!1;a.WritingDevice=!1;b&&(a.id=b.id,a.name=b.name,a.device_mac=b.device_mac,a.present(b.present));a.connect=function(){a.device=BC.bluetooth.devices[a.device_mac];a.device.connect(a.connectionSuccess,a.connectionError,CHANEL,!0);a.device.addEventListener("deviceconnected",
a.prepareStudentAndWrite)};a.setAsCurrent=function(){window.localStorage.setItem("currentStudentID",a.id)};a.connectionSuccess=function(){};a.connectionError=function(){a.triesCounter<=a.MAXATTEMPS&&(logmsg("No se pudo conectar con"+a.device.deviceName+" intentando de nuevo"),a.device.connect(a.connectionSuccess,a.connectionError,CHANEL,!0),a.triesCounter++)};a.MarcarPresente=function(){swal({title:"\u00bfEstas seguro de marcar como presente a este alumno?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",
confirmButtonText:"Marcar Presente",closeOnConfirm:!1},function(){Server.pasarPresente(a.id,window.vm.currentClassID,function(b){window.vm.alumnosPresentes.push(a);window.vm.alumnos.remove(a);swal("Ok","Alumno marcado como Presente!","success")},function(a){alert("No se le pudo pasar presente")})})};a.prepareStudentAndWrite=function(b){a.connectedDevice=b;logmsg("device:"+b.deviceAddress+"conectado");a.device.prepare(a.tryWrite,a.prepareError)};a.tryWrite=function(){a.device.rfcommWrite("ascii","ping",
a.writeSuccess,a.writeError)};a.prepareError=function(b){logmsg("No se pudo preparar el dispositivo.");a.device.prepare(a.tryWrite,a.prepareError);console.log(b)};a.writeSuccess=function(){logmsg("Se envio la confirmaci\u00f3n correctamente a "+a.name);a.present(!0);a.device.disconnect(a.disconnectSuccess,a.disconnectError)};a.writeError=function(){logmsg("no se pudo escribir, intentando de nuevo.");a.device.rfcommWrite("ascii","ping",a.writeSuccess,a.writeError)};a.readSuccess=function(b){var d=
b.value.getASCIIString();b=new String("ok");d=d.slice(0,2);b.valueOf()==d.valueOf()?(logmsg("ping back recibido!"),a.present(!0),a.device.disconnect(a.disconnectSuccess,a.disconnectError)):(logmsg("Lo que lei no es mi dato jiji"),a.device.rfcommRead(a.readSuccess,a.readError))};a.readError=function(){logmsg("No pude leer la confirmacion del alumno, intentando otra vez");a.device.rfcommRead(a.readSuccess,a.readError)};a.disconnectSuccess=function(){BC.Bluetooth.StopScan();window.vm.scanDevices();logmsg("Se desconecto del alumno correctamente.")};
a.disconnectError=function(){logmsg("no se pudo desconectar, intentando de nuevo.");a.device.disconnect(a.disconnectSuccess,a.disconnectError)}}
function AsistenciaViewModel(){var b=this;b.detectedDevices=ko.observableArray([]);b.alumnos=ko.observableArray([]);b.alumnosPresentes=ko.observableArray([]);b.currentClassID=0;b.currentCursoname=ko.observable(currentCursoName);b.getDataSuccess=function(a){a=$.map(a.alumnos,function(a){return new AlumnoViewModel({name:a.nombre+" "+a.apellido,device_mac:a.device_address,present:!1,id:a.id})});b.alumnos(a)};b.getDataFailure=function(a){console.error(a.error)};cordovaHTTP.get(getCursoURL+currentCursoID,
{},{},function(a){b.getDataSuccess(JSON.parse(a.data))},function(a){b.getDataFailure(a)});b.registerStudent=function(a){b.alumnos.push(a);b.detectedDevices.remove(a)};b.openBTError=function(){logmsg("No pudo abrirse el bluetooth")};b.openBTSuccess=function(a){logmsg("Empiezo a tomar asistencia!");document.getElementById("preload").style.display="";BC.Bluetooth.StartScan()};b.classCreatedSuccess=function(a){a.status?(b.currentClassID=a.id,$("#completar").show(),$(".presente-manual").show(),BC.bluetooth.addEventListener("newdevice",
b.deviceFound),BC.Bluetooth.OpenBluetooth(b.openBTSuccess,b.openBTError)):alert("opsie volver a intentar")};b.classCreatedFailure=function(a){alert("no crear")};b.tomarAsistencia=function(){var a=new Date,c=a.getDate()+"/"+a.getMonth()+"/"+a.getFullYear(),a=a.getHours()+":"+a.getMinutes()+":"+a.getSeconds();Server.crearClase(currentCursoID,c,a,"",b.classCreatedSuccess,b.classCreatedFailure)};b.marcarCompletadoSuccess=function(a){a.status&&swal("Ok","clase marcada como completada!","success")};b.marcarCompletadoFailure=
function(a){swal("Error","no se pudo marcar la clase como completada, vuelva a intentarlo","error")};b.marcarCompletado=function(){$("#preload").hide();Server.marcarClaseCompletada(b.currentClassID,b.marcarCompletadoSuccess,b.marcarCompletadoFailure)};b.deviceFound=function(a){var c=a.target;a=ko.utils.arrayFirst(b.alumnos(),function(a){return c.deviceAddress.toUpperCase()==a.device_mac.toUpperCase()});var d=ko.utils.arrayFirst(b.detectedDevices(),function(a){return c.deviceAddress.toUpperCase()==
a.device_mac.toUpperCase()});a&&!a.present()?(Server.pasarPresente(a.id,b.currentClassID,b.pasarPresenteSuccess,b.pasarPresenteFailure),b.alumnosPresentes.push(a),b.alumnos.remove(a),a.present(!0)):d||(a=new AlumnoViewModel({name:c.deviceName,device_mac:c.deviceAddress,present:!1}),b.detectedDevices.push(a))};b.debug=function(){console.log("hey")}};